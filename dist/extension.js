"use strict";var E=Object.create;var p=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var b=(e,i)=>{for(var a in i)p(e,a,{get:i[a],enumerable:!0})},T=(e,i,a,l)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of P(i))!N.call(e,s)&&s!==a&&p(e,s,{get:()=>i[s],enumerable:!(l=g(i,s))||l.enumerable});return e};var C=(e,i,a)=>(a=e!=null?E(O(e)):{},T(i||!e||!e.__esModule?p(a,"default",{value:e,enumerable:!0}):a,e)),y=e=>T(p({},"__esModule",{value:!0}),e);var $={};b($,{activate:()=>_,deactivate:()=>k});module.exports=y($);var o=C(require("vscode"));var exec=require("child_process").exec;function k(){}var v="opencode";function _(e){let i=o.commands.registerCommand("opencode.openNewTerminal",async()=>{await s()}),a=o.commands.registerCommand("opencode.openTerminal",async()=>{let t=o.window.terminals.find(n=>n.name===v);if(t){t.show();return}await s()}),l=o.commands.registerCommand("opencode.addFilepathToTerminal",async()=>{let t=u();if(!t)return;let n=o.window.activeTerminal;if(n&&n.name===v){let r=n.creationOptions.env?._EXTENSION_OPENCODE_PORT;r?await h(parseInt(r),t):n.sendText(t,!1),n.show()}});e.subscriptions.push(a,l);async function x(t){return new Promise((n,r)=>{exec(`netstat -ano | findstr :${t}`,(i,a,l)=>{if(i){n(null);return}let f=a.match(/\r?\n?\s*TCP\s+[^\s]+\s+[^\s]+\s+[^\s]+\s+(\d+)/);if(f&&f[1]){n(parseInt(f[1]))}else{n(null)}})})}async function s(){let t=o.workspace.getConfiguration("opencode").get("port")||Math.floor(Math.random()*49152)+16384;if(t){let p=await x(t);if(p){try{exec(`taskkill /PID ${p} /F`),console.log(`Killed process ${p} using port ${t}`)}catch(e){console.error(`Failed to kill process: ${e}`)}}}let n=o.window.createTerminal({name:v,iconPath:{light:o.Uri.file(e.asAbsolutePath("images/button-dark.svg")),dark:o.Uri.file(e.asAbsolutePath("images/button-light.svg"))},location:{viewColumn:o.ViewColumn.Beside,preserveFocus:!1},env:{_EXTENSION_OPENCODE_PORT:t.toString(),OPENCODE_CALLER:"vscode"}});n.show(),n.sendText(`opencode --port ${t}`);let r=u();if(!r)return;let m=10,c=!1;do{await new Promise(d=>setTimeout(d,200));try{await fetch(`http://localhost:${t}/app`),c=!0;break}catch{}m--}while(m>0);c&&(await h(t,`In ${r}`),n.show())}async function h(t,n){await fetch(`http://localhost:${t}/tui/append-prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n})})}function u(){let t=o.window.activeTextEditor;if(!t)return;let n=t.document;if(!o.workspace.getWorkspaceFolder(n.uri))return;let c=`@${o.workspace.asRelativePath(n.uri)}`,d=t.selection;if(!d.isEmpty){let f=d.start.line+1,w=d.end.line+1;f===w?c+=`#L${f}`:c+=`#L${f}-${w}`}return c}}0&&(module.exports={activate,deactivate});
